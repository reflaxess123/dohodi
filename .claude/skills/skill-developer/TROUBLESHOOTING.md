# Устранение неполадок - Проблемы активации скиллов

Полное руководство по отладке проблем активации скиллов.

## Оглавление

- [Скилл не активируется](#скилл-не-активируется)
  - [UserPromptSubmit не предлагает](#userpromptsubmit-не-предлагает)
  - [PreToolUse не блокирует](#pretooluse-не-блокирует)
- [Ложные срабатывания](#ложные-срабатывания)
- [Хук не выполняется](#хук-не-выполняется)
- [Проблемы производительности](#проблемы-производительности)

---

## Скилл не активируется

### UserPromptSubmit не предлагает

**Симптомы:** Задаёте вопрос, но предложение скилла не появляется в выводе.

**Распространённые причины:**

####  1. Ключевые слова не совпадают

**Проверьте:**
- Посмотрите `promptTriggers.keywords` в skill-rules.json
- Присутствуют ли ключевые слова в вашем промпте?
- Помните: регистронезависимое сопоставление подстроки

**Пример:**
```json
"keywords": ["layout", "grid"]
```
- "как работает layout?" → ✅ Совпадает с "layout"
- "как работает система grid?" → ✅ Совпадает с "grid"
- "как работают layouts?" → ✅ Совпадает с "layout"
- "как это работает?" → ❌ Нет совпадения

**Исправление:** Добавьте больше вариаций ключевых слов в skill-rules.json

#### 2. Паттерны намерений слишком специфичны

**Проверьте:**
- Посмотрите `promptTriggers.intentPatterns`
- Протестируйте regex на https://regex101.com/
- Возможно, нужны более широкие паттерны

**Пример:**
```json
"intentPatterns": [
  "(create|add).*?(database.*?table)"  // Слишком специфично
]
```
- "создать таблицу базы данных" → ✅ Совпадает
- "добавить новую таблицу" → ❌ Не совпадает (отсутствует "database")

**Исправление:** Расширьте паттерн:
```json
"intentPatterns": [
  "(create|add).*?(table|database)"  // Лучше
]
```

#### 3. Опечатка в имени скилла

**Проверьте:**
- Имя скилла в frontmatter SKILL.md
- Имя скилла в skill-rules.json
- Должны совпадать точно

**Пример:**
```yaml
# SKILL.md
name: project-catalog-developer
```
```json
// skill-rules.json
"project-catalogue-developer": {  // ❌ Опечатка: catalogue vs catalog
  ...
}
```

**Исправление:** Сделайте имена точно совпадающими

#### 4. Ошибка синтаксиса JSON

**Проверьте:**
```bash
cat .claude/skills/skill-rules.json | jq .
```

Если JSON невалидный, jq покажет ошибку.

**Распространённые ошибки:**
- Висячие запятые
- Отсутствующие кавычки
- Одинарные кавычки вместо двойных
- Неэкранированные символы в строках

**Исправление:** Исправьте синтаксис JSON, проверьте с jq

#### Команда отладки

Протестируйте хук вручную:

```bash
echo '{"session_id":"debug","prompt":"ваш тестовый промпт"}' | \
  npx tsx .claude/hooks/skill-activation-prompt.ts
```

Ожидаемо: Ваш скилл должен появиться в выводе.

---

### PreToolUse не блокирует

**Симптомы:** Редактируете файл, который должен активировать защиту, но блокировка не происходит.

**Распространённые причины:**

#### 1. Путь файла не совпадает с паттернами

**Проверьте:**
- Путь редактируемого файла
- `fileTriggers.pathPatterns` в skill-rules.json
- Синтаксис glob-паттернов

**Пример:**
```json
"pathPatterns": [
  "frontend/src/**/*.tsx"
]
```
- Редактирование: `frontend/src/components/Dashboard.tsx` → ✅ Совпадает
- Редактирование: `frontend/tests/Dashboard.test.tsx` → ✅ Совпадает (добавьте исключение!)
- Редактирование: `backend/src/app.ts` → ❌ Не совпадает

**Исправление:** Настройте glob-паттерны или добавьте недостающий путь

#### 2. Исключено через pathExclusions

**Проверьте:**
- Редактируете ли вы тестовый файл?
- Посмотрите `fileTriggers.pathExclusions`

**Пример:**
```json
"pathExclusions": [
  "**/*.test.ts",
  "**/*.spec.ts"
]
```
- Редактирование: `services/user.test.ts` → ❌ Исключён
- Редактирование: `services/user.ts` → ✅ Не исключён

**Исправление:** Если исключение тестов слишком широкое, сузьте или удалите

#### 3. Паттерн контента не найден

**Проверьте:**
- Содержит ли файл на самом деле этот паттерн?
- Посмотрите `fileTriggers.contentPatterns`
- Правильный ли regex?

**Пример:**
```json
"contentPatterns": [
  "import.*[Pp]risma"
]
```
- Файл содержит: `import { PrismaService } from './prisma'` → ✅ Совпадает
- Файл содержит: `import { Database } from './db'` → ❌ Не совпадает

**Отладка:**
```bash
# Проверьте, есть ли паттерн в файле
grep -i "prisma" path/to/file.ts
```

**Исправление:** Настройте паттерны контента или добавьте недостающие импорты

#### 4. Сессия уже использовала скилл

**Проверьте состояние сессии:**
```bash
ls .claude/hooks/state/
cat .claude/hooks/state/skills-used-{session-id}.json
```

**Пример:**
```json
{
  "skills_used": ["database-verification"],
  "files_verified": []
}
```

Если скилл в `skills_used`, он не заблокирует снова в этой сессии.

**Исправление:** Удалите файл состояния для сброса:
```bash
rm .claude/hooks/state/skills-used-{session-id}.json
```

#### 5. Присутствует маркер файла

**Проверьте файл на маркер пропуска:**
```bash
grep "@skip-validation" path/to/file.ts
```

Если найден, файл постоянно пропускается.

**Исправление:** Удалите маркер, если проверка снова нужна

#### 6. Переопределение переменной окружения

**Проверьте:**
```bash
echo $SKIP_DB_VERIFICATION
echo $SKIP_SKILL_GUARDRAILS
```

Если установлено, скилл отключён.

**Исправление:** Сбросьте переменную окружения:
```bash
unset SKIP_DB_VERIFICATION
```

#### Команда отладки

Протестируйте хук вручную:

```bash
cat <<'EOF' | npx tsx .claude/hooks/skill-verification-guard.ts 2>&1
{
  "session_id": "debug",
  "tool_name": "Edit",
  "tool_input": {"file_path": "/root/git/your-project/form/src/services/user.ts"}
}
EOF
echo "Exit code: $?"
```

Ожидаемо:
- Код выхода 2 + сообщение stderr если должен блокировать
- Код выхода 0 + без вывода если должен разрешить

---

## Ложные срабатывания

**Симптомы:** Скилл активируется, когда не должен.

**Распространённые причины и решения:**

### 1. Ключевые слова слишком общие

**Проблема:**
```json
"keywords": ["user", "system", "create"]  // Слишком широко
```
- Срабатывает на: "user manual", "file system", "create directory"

**Решение:** Сделайте ключевые слова более специфичными
```json
"keywords": [
  "user authentication",
  "user tracking",
  "create feature"
]
```

### 2. Паттерны намерений слишком широкие

**Проблема:**
```json
"intentPatterns": [
  "(create)"  // Совпадает с всем, что содержит "create"
]
```
- Срабатывает на: "create file", "create folder", "create account"

**Решение:** Добавьте контекст к паттернам
```json
"intentPatterns": [
  "(create|add).*?(database|table|feature)"  // Более специфично
]
```

**Продвинуто:** Используйте негативный просмотр вперёд для исключения
```regex
(create)(?!.*test).*?(feature)  // Не совпадает, если появляется "test"
```

### 3. Пути файлов слишком общие

**Проблема:**
```json
"pathPatterns": [
  "form/**"  // Совпадает со всем в form/
]
```
- Срабатывает на: тестовые файлы, конфигурационные файлы, всё

**Решение:** Используйте более узкие паттерны
```json
"pathPatterns": [
  "form/src/services/**/*.ts",  // Только файлы сервисов
  "form/src/controllers/**/*.ts"
]
```

### 4. Паттерны контента ловят нерелевантный код

**Проблема:**
```json
"contentPatterns": [
  "Prisma"  // Совпадает в комментариях, строках и т.д.
]
```
- Срабатывает на: `// Don't use Prisma here`
- Срабатывает на: `const note = "Prisma is cool"`

**Решение:** Сделайте паттерны более специфичными
```json
"contentPatterns": [
  "import.*[Pp]risma",        // Только импорты
  "PrismaService\\.",         // Только реальное использование
  "prisma\\.(findMany|create)" // Конкретные методы
]
```

### 5. Измените уровень принуждения

**Крайняя мера:** Если ложные срабатывания частые:

```json
{
  "enforcement": "block"  // Измените на "suggest"
}
```

Это делает скилл рекомендательным вместо блокирующего.

---

## Хук не выполняется

**Симптомы:** Хук вообще не запускается - нет предложения, нет блокировки.

**Распространённые причины:**

### 1. Хук не зарегистрирован

**Проверьте `.claude/settings.json`:**
```bash
cat .claude/settings.json | jq '.hooks.UserPromptSubmit'
cat .claude/settings.json | jq '.hooks.PreToolUse'
```

Ожидаемо: Записи хуков присутствуют

**Исправление:** Добавьте недостающую регистрацию хука:
```json
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/skill-activation-prompt.sh"
          }
        ]
      }
    ]
  }
}
```

### 2. Bash-обёртка не исполняемая

**Проверьте:**
```bash
ls -l .claude/hooks/*.sh
```

Ожидаемо: `-rwxr-xr-x` (исполняемый)

**Исправление:**
```bash
chmod +x .claude/hooks/*.sh
```

### 3. Неправильный shebang

**Проверьте:**
```bash
head -1 .claude/hooks/skill-activation-prompt.sh
```

Ожидаемо: `#!/bin/bash`

**Исправление:** Добавьте правильный shebang в первую строку

### 4. npx/tsx недоступен

**Проверьте:**
```bash
npx tsx --version
```

Ожидаемо: Номер версии

**Исправление:** Установите зависимости:
```bash
cd .claude/hooks
npm install
```

### 5. Ошибка компиляции TypeScript

**Проверьте:**
```bash
cd .claude/hooks
npx tsc --noEmit skill-activation-prompt.ts
```

Ожидаемо: Нет вывода (нет ошибок)

**Исправление:** Исправьте синтаксические ошибки TypeScript

---

## Проблемы производительности

**Симптомы:** Хуки работают медленно, заметная задержка перед промптом/редактированием.

**Распространённые причины:**

### 1. Слишком много паттернов

**Проверьте:**
- Посчитайте паттерны в skill-rules.json
- Каждый паттерн = компиляция regex + сопоставление

**Решение:** Уменьшите паттерны
- Объедините похожие паттерны
- Удалите избыточные паттерны
- Используйте более специфичные паттерны (более быстрое сопоставление)

### 2. Сложный regex

**Проблема:**
```regex
(create|add|modify|update|implement|build).*?(feature|endpoint|route|service|controller|component|UI|page)
```
- Длинные альтернативы = медленно

**Решение:** Упростите
```regex
(create|add).*?(feature|endpoint)  // Меньше альтернатив
```

### 3. Слишком много файлов проверяется

**Проблема:**
```json
"pathPatterns": [
  "**/*.ts"  // Проверяет ВСЕ TypeScript файлы
]
```

**Решение:** Будьте более специфичны
```json
"pathPatterns": [
  "form/src/services/**/*.ts",  // Только конкретная директория
  "form/src/controllers/**/*.ts"
]
```

### 4. Большие файлы

Сопоставление паттернов контента читает весь файл - медленно для больших файлов.

**Решение:**
- Используйте паттерны контента только когда действительно необходимо
- Рассмотрите ограничения размера файла (будущее улучшение)

### Измерение производительности

```bash
# UserPromptSubmit
time echo '{"prompt":"test"}' | npx tsx .claude/hooks/skill-activation-prompt.ts

# PreToolUse
time cat <<'EOF' | npx tsx .claude/hooks/skill-verification-guard.ts
{"tool_name":"Edit","tool_input":{"file_path":"test.ts"}}
EOF
```

**Целевые метрики:**
- UserPromptSubmit: < 100мс
- PreToolUse: < 200мс

---

**Связанные файлы:**
- [SKILL.md](SKILL.md) - Главное руководство по скиллам
- [HOOK_MECHANISMS.md](HOOK_MECHANISMS.md) - Как работают хуки
- [SKILL_RULES_REFERENCE.md](SKILL_RULES_REFERENCE.md) - Справочник конфигурации
